<!DOCTYPE html>
<html lang="pt-Br">

<head>
  <meta charset="UTF-8">
  <!-- <meta name="viewport" content="width=device-width, initial-scale=1.0"> -->
  <meta name="viewport" content="width=device-width">
  <link rel="stylesheet" href="./style.css">
  <link rel="shortcut icon" href="./Assets/M.ico" type="image/x-icon">

  </script>

  <title>Lista de indica√ß√µes</title>
</head>
<!-- Script que fixa os bot√µes no topo da pagina ao rolar a p√°gina.[Inicio] -->
<script type="text/javascript">
  window.onscroll = scroll;
  function scroll() {
    var nVScroll = document.documentElement.scrollTop || document.body.scrollTop; if (nVScroll > 100) {
      document.getElementById("item1").classList.add('menuFixo');
    } else { document.getElementById("item1").classList.remove('menuFixo'); }

  }

  /* Script que fixa os bot√µes no topo da pagina ao rolar a p√°gina.[Fim] */

</script>


<body>

  <section class="container">

    <header class="header-content">

      <div><img class="imgHeader" src="./Assets/LogoMeet-New.png" alt="" srcset=""></div>
      <div>
        <h1>Meet <span>News</span>üóûÔ∏è</h1>
      </div>
      <div><span id="dataHora"></span></div>

    </header>

    <main class="main-content">


      <div id="item1" class="item1">

        <div class="buttons"><img class="imgItem1" src="./Assets/LogoMeet-New.png" width="40" height="40" alt=""
            srcset=""></div>
        <div class="buttons"><button class="btn btnPortaria">Portaria</button></div>
        <div class="buttons"><button class="btn btnIndicacoes"><a href="./indicacoes.html" target="_blank"> Indica√ß√µes </a></button></div>
        <div class="buttons"><button class="btn btnAssembleias">Assembleias</button></div>
        <div class="buttons"><button class="btn btnPaterns">Paterns</button></div>

      </div>


      <div class="itens item2">
        <button class="addBtn" onclick="openModalNew(),closeModalUpdate()"><img src="./Assets/btnAdd32.png" alt=""
            srcset=""></button>
        <!-- Modal para adicionar as noticias na tela [Inicio] -->
        <div class="modalContent" id="showModal">
          <div class="modalAddNews">

            <h1>Inserir noticias</h1>

            <input id="data" type="date" name="data" placeholder="Informe a data">

            <input id="titulo" type="text" placeholder="Informe o t√≠tulo">

            <textarea id="conteudo" name="story" rows="20" cols="40" placeholder="Informe o conte√∫do."></textarea>

            <div class="adicionar">
              <button id="AddBtn" class="btn">Adicionar</button>
            </div>
          </div>
        </div>
        <!-- Modal para adicionar as noticias na tela [Fim] -->

        <!-- Modal para corrigir as noticias na tela [Inicio] -->
        <div class="modalContent" id="showModalCorrigir">
          <div class="modalAddNews">

            <h1>Atualizar noticias</h1>

            <input id="dataUpd" type="date">

            <input id="tituloUpd" type="text" placeholder="Informe o t√≠tulo">

            <textarea id="conteudoUpd" name="story" rows="20" cols="40" placeholder="Informe o conte√∫do."></textarea>

            
            <div class="adicionar">
              <button id="UpdateBtn" class="btn">Atualizar noticias</button>

            </div>
          </div>
        </div>
        <!-- Modal para corrigir as noticias na tela [Fim] -->

        <!-- √Årea do conte√∫do da p√°gina -->
        <div id="contentPost" class="post-container"></div>

      </div>

    </main>

    <footer class="footer-content">

      <div>
        <p>Criado <span>voluntariamente</span> para reunir as informa√ß√µes em um mesmo local.</p>
      </div>
      <div>Criado por Vin√≠cius Oliveira ¬Æ.</div>

    </footer>

  </section>
  <script src="./funcoes.js"></script>

  <script type="module">
    // Importa√ß√£o de componentes do banco de dados
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
    import { query, getDatabase, ref, child, get, set, update, remove, orderByKey, orderByChild } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-database.js";
    import { orderByValue, limitToLast, limitToFirst, equalTo, startAt } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-database.js";

    // Configura√ß√µes da conex√£o do banco de dados
    const firebaseConfig = {
      apiKey: "AIzaSyBxnFt-BFIPOzLBHGIKCO2OZgNCpx0Ufbo",
      authDomain: "meetnews-1c4bf.firebaseapp.com",
      projectId: "meetnews-1c4bf",
      storageBucket: "meetnews-1c4bf.appspot.com",
      messagingSenderId: "623938736140",
      appId: "1:623938736140:web:5cd1c5529f81c793e15e29"
    };

    // Realiza a conex√£o com o banco
    const app = initializeApp(firebaseConfig);
    const db = getDatabase();

    // Carrega as os compenentes nas vari√°veis
    let data        = document.getElementById("data");
    let titulo      = document.getElementById('titulo');
    let conteudo    = document.getElementById('conteudo');
    let tituloUpd   = document.getElementById('tituloUpd');
    let conteudoUpd = document.getElementById('conteudoUpd');
    let dataUpd = document.getElementById('dataUpd');
    let btn         = document.getElementById('AddBtn');
    let btnUpd      = document.getElementById('UpdateBtn');
   // let id = crypto.randomUUID();
    var idNoticiasUpd;
    var idNoticiasDel;
    var lastId = 0;


    //Fun√ß√£o que grava os dados no banco.
    function addData() {
      let incrementedId =  parseInt(lastId) + parseInt(1);
  
      if(data.value === "" || titulo.value === "" || conteudo.value === ""){
      alert("Alguns dados n√£o foram preenchidos, todos eles s√£o obrigat√≥rios verifique!");
     } else {

      let dataFormatada = (new Date(data.value)).toISOString().match(/^[0-9]{4}\-[0-9]{2}\-[0-9]{2}/)[0].split('-').reverse().join('/');

      set(ref(db, 'Postagens/' + incrementedId), {
        id: incrementedId,
        data: dataFormatada,
        titulo: titulo.value,
        conteudo: conteudo.value

      }).then(() => {
        alert("Noticia gravada com sucesso!");
        window.location.reload(true);
      }).catch(() => {
        alert("N√£o gravou! Verifique.");
      })
     }
    }
    //Fun√ß√£o que atualiza os dados no banco.
    function atualizarDados() {
      
      if (tituloUpd.value === "" || conteudoUpd.value === ""){
        alert("Vazio espertinho(a)!");
      }
     else{
      update(ref(db, 'Postagens/' + idNoticiasUpd), {
       
        titulo: tituloUpd.value,
        conteudo: conteudoUpd.value

      }).then(() => {
        alert("Noticia atualizada com sucesso!");
        window.location.reload(true);
      }).catch(() => {
        alert("N√£o gravou! Verifique.");
      })
      }
    }
    //Fun√ß√£o que deleta os dados no banco.
    function deletarDados() {

      remove(ref(db, 'Postagens/' + idNoticiasDel))
      .then(() => {
       alert("Noticia deletada com sucesso!");
       window.location.reload(true);
     }).catch(() => {
       alert("N√£o deletou! Verifique.");
     })

    }

    //Fun√ß√£o que obtem os dados do banco e carrega na tela.
    document.addEventListener('DOMContentLoaded', function RetData() {

      //Constantes que recebem o banco de dados.
      const dbRef = ref(db);
      const recentPostsRef = query(ref(db, 'Postagens/'));

      //Varre os dados do banco.
      get(recentPostsRef)
        .then((snapshot) => {

          //Crio um array que receber√° os valores recebidos do banco.
          var noticias = [];
          var ids = [];

          //Percorro o objeto recebido.
          snapshot.forEach(childSnapshot => {
            //Adiciono os dados no array.  
            noticias.push(childSnapshot.val());
            ids.push(childSnapshot.val());
          });
          

          noticias.forEach(recebeId => {
            lastId = recebeId.id;
          })

          //Nessa parte eu inverto o array como se fosse um order by desc.
          noticias.reverse();
          noticias.forEach(element => {
            
            /* Tratando data [Inicio]. */
            let dataExt = element.data;
            //Extraindo dia m√™s e ano da data  
            let dia = dataExt.slice(0, 2);
            let mes = dataExt.substr(3, 2);
            let ano = dataExt.substr(6, 4);
            let mesExtenso;

            //Passando os meses para extenso [Inicio]
            if(mes === "01"){mesExtenso = "Jan"}
            if(mes === "02"){mesExtenso = "Fev"}
            if(mes === "03"){mesExtenso = "Mar√ßo"}
            if(mes === "04"){mesExtenso = "Abril"}
            if(mes === "05"){mesExtenso = "Maio"}
            if(mes === "06"){mesExtenso = "Junho"}
            if(mes === "07"){mesExtenso = "Julho"}
            if(mes === "08"){mesExtenso = "Agosto"}
            if(mes === "09"){mesExtenso = "Setembro"}
            if(mes === "10"){mesExtenso = "Outubro"}
            if(mes === "11"){mesExtenso = "Novembro"}
            if(mes === "12"){mesExtenso = "Dezembro"}
                       
            let dataTratada = dia + ' ' + 'de' + ' ' + mesExtenso + ' ' + 'de' + ' ' + ano;

            //Trata os meses [Fim]

            /* Criando arquitetura de exibi√ß√£o dos dados. [Inicio]*/
            var divPostContainer = document.createElement('div');
            divPostContainer.className = 'post-container';

            var divPost = document.createElement('div');
            divPost.className = 'post';

            var dateP = document.createElement('p');
            dateP.className = 'date';
            dateP.innerHTML = dataTratada;

            var postBr = document.createElement('br');
            var tituloPost = document.createElement('h1');
            tituloPost.innerHTML = element.titulo;

            var contentPost = document.createElement('div');
            contentPost.className = 'post-content';

            var conteudoSaltaLinha = document.createElement('br');
            var conteudoParagrafo = document.createElement('p');
            var conteudoUnderLine = document.createElement('hr');
            var btnAtualiza = document.createElement('btn');
            var btnDeleta = document.createElement('btn');

            //DIV de a√ß√µes [Inicio]
            var contentAcoes = document.createElement('div');
            contentAcoes.className = 'Acoes';
            btnAtualiza.className = 'btnAcoesAtualiza';

            //Associa o evento de click ao bot√£o de atualiza√ß√£o
            btnAtualiza.addEventListener('click', function atualizar() {
              closeModalNew();
              openModalUpdate();

              let dataExtTeste = element.data;
            //Extraindo o dia da data  
            let dia = dataExtTeste.slice(0, 2);
            let mes = dataExtTeste.substr(3, 2);
            let ano = dataExtTeste.substr(6, 4);
            
            console.log(dia);
            console.log(mes);
            console.log(ano);
            
              idNoticiasUpd = element.id;

              get(child(dbRef, 'Postagens/' + element.id)).then((snapshot) => {
                if (snapshot.exists()) {
                //  let dataFormatadaUpd = (new Date(snapshot.val().data)).toISOString().match(/^[0-9]{4}\-[0-9]{2}\-[0-9]{2}/)[0].split("-").reverse().join('/');

                    document.getElementById('dataUpd').value     = ano + "-" + mes + "-" + dia //snapshot.val().data;
                    document.getElementById('tituloUpd').value   = snapshot.val().titulo;
                    document.getElementById('conteudoUpd').value = snapshot.val().conteudo;


                } else {
                  alert("Employee does not exists");
                }
              }).catch((error) => {
                alert("Sem sucesso!");
                console.log(error);
              })
            });

            //Associa o evento de click ao bot√£o de dele√ß√£o
            btnDeleta.className = 'btnAcoesDeleta';
            btnDeleta.addEventListener('click', function atualizar() {
              closeModalNew();
              closeModalUpdate();

              idNoticiasDel = element.id;

              deletarDados();
            });

            //DIV de a√ß√µes [Fim]

            conteudoParagrafo.innerHTML = element.conteudo;
            /* Criando arquitetura de exibi√ß√£o dos dados. [Fim]*/

            /* Montando no DOM a estrutura criada [Inicio] */
            document.getElementById('contentPost').appendChild(divPost);
            divPost.appendChild(dateP);
            divPost.appendChild(postBr);
            divPost.appendChild(contentAcoes);
            contentAcoes.appendChild(btnAtualiza);
            contentAcoes.appendChild(btnDeleta);
            divPost.appendChild(tituloPost);
            divPost.appendChild(contentPost);
            contentPost.appendChild(conteudoSaltaLinha);
            contentPost.appendChild(conteudoParagrafo);
            contentPost.appendChild(conteudoUnderLine);
            /* Montando no DOM a estrutura criada [Fim] */

          });
        });
    }, false);

    btn.addEventListener('click', addData);
    btnUpd.addEventListener('click', atualizarDados);

    // btnRet.addEventListener('click', RetData());

  </script>
</body>

</html>